<!DOCTYPE html>
<!-- this is trailrunner
  it's a static HTML/JS page that I'm using to experiment with JSPM and automerge-repo
  the eventual goal is to have JSPM load an automerge-repo doc and bootstrap up a react app out of it
  we'll get there soon, i think
-->
<!-- either use "defer" or load this polyfill after the scripts below-->
<html>
  <script async src="./es-module-shims@1.7.3.js"></script>
  <script type="importmap">
    {
      "imports": {
        "@automerge/automerge-repo": "https://ga.jspm.io/npm:@automerge/automerge-repo@0.1.2/dist/index.js",
        "@automerge/automerge-repo-storage-localforage": "https://ga.jspm.io/npm:@automerge/automerge-repo-storage-localforage@0.1.2/dist/index.js",
        "@jspm/generator": "https://ga.jspm.io/npm:@jspm/generator@1.1.9/dist/generator.js",
        "@jspm/import-map": "https://ga.jspm.io/npm:@jspm/import-map@1.0.7/dist/map.js",
        "codemirror": "https://ga.jspm.io/npm:codemirror@6.0.1/dist/index.js"
      },
      "scopes": {
        "https://ga.jspm.io/": {
          "#fetch": "https://ga.jspm.io/npm:@jspm/generator@1.1.9/dist/fetch-native.js",
          "#lib/config/files/index.js": "https://ga.jspm.io/npm:@babel/core@7.22.5/lib/config/files/index-browser.js",
          "#lib/config/resolve-targets.js": "https://ga.jspm.io/npm:@babel/core@7.22.5/lib/config/resolve-targets-browser.js",
          "#lib/transform-file.js": "https://ga.jspm.io/npm:@babel/core@7.22.5/lib/transform-file-browser.js",
          "#node.js": "https://ga.jspm.io/npm:browserslist@4.21.9/browser.js",
          "@ampproject/remapping": "https://ga.jspm.io/npm:@ampproject/remapping@2.2.1/dist/remapping.umd.js",
          "@automerge/automerge": "https://ga.jspm.io/npm:@automerge/automerge@2.1.0-alpha.8/dist/mjs/index.js",
          "@automerge/automerge-wasm": "https://ga.jspm.io/npm:@automerge/automerge-wasm@0.2.7/bundler/automerge_wasm.js",
          "@babel/code-frame": "https://ga.jspm.io/npm:@babel/code-frame@7.22.5/lib/index.js",
          "@babel/compat-data/native-modules": "https://ga.jspm.io/npm:@babel/compat-data@7.22.5/native-modules.js",
          "@babel/compat-data/plugins": "https://ga.jspm.io/npm:@babel/compat-data@7.22.5/plugins.js",
          "@babel/core": "https://ga.jspm.io/npm:@babel/core@7.22.5/lib/dev.index.js",
          "@babel/generator": "https://ga.jspm.io/npm:@babel/generator@7.22.5/lib/index.js",
          "@babel/helper-annotate-as-pure": "https://ga.jspm.io/npm:@babel/helper-annotate-as-pure@7.22.5/lib/index.js",
          "@babel/helper-compilation-targets": "https://ga.jspm.io/npm:@babel/helper-compilation-targets@7.22.5/lib/index.js",
          "@babel/helper-create-class-features-plugin": "https://ga.jspm.io/npm:@babel/helper-create-class-features-plugin@7.22.5/lib/index.js",
          "@babel/helper-environment-visitor": "https://ga.jspm.io/npm:@babel/helper-environment-visitor@7.22.5/lib/index.js",
          "@babel/helper-function-name": "https://ga.jspm.io/npm:@babel/helper-function-name@7.22.5/lib/index.js",
          "@babel/helper-hoist-variables": "https://ga.jspm.io/npm:@babel/helper-hoist-variables@7.22.5/lib/index.js",
          "@babel/helper-member-expression-to-functions": "https://ga.jspm.io/npm:@babel/helper-member-expression-to-functions@7.22.5/lib/index.js",
          "@babel/helper-module-imports": "https://ga.jspm.io/npm:@babel/helper-module-imports@7.22.5/lib/index.js",
          "@babel/helper-module-transforms": "https://ga.jspm.io/npm:@babel/helper-module-transforms@7.22.5/lib/index.js",
          "@babel/helper-optimise-call-expression": "https://ga.jspm.io/npm:@babel/helper-optimise-call-expression@7.22.5/lib/index.js",
          "@babel/helper-plugin-utils": "https://ga.jspm.io/npm:@babel/helper-plugin-utils@7.22.5/lib/index.js",
          "@babel/helper-replace-supers": "https://ga.jspm.io/npm:@babel/helper-replace-supers@7.22.5/lib/index.js",
          "@babel/helper-simple-access": "https://ga.jspm.io/npm:@babel/helper-simple-access@7.22.5/lib/index.js",
          "@babel/helper-skip-transparent-expression-wrappers": "https://ga.jspm.io/npm:@babel/helper-skip-transparent-expression-wrappers@7.22.5/lib/index.js",
          "@babel/helper-split-export-declaration": "https://ga.jspm.io/npm:@babel/helper-split-export-declaration@7.22.5/lib/index.js",
          "@babel/helper-string-parser": "https://ga.jspm.io/npm:@babel/helper-string-parser@7.22.5/lib/index.js",
          "@babel/helper-validator-identifier": "https://ga.jspm.io/npm:@babel/helper-validator-identifier@7.22.5/lib/index.js",
          "@babel/helper-validator-option": "https://ga.jspm.io/npm:@babel/helper-validator-option@7.22.5/lib/index.js",
          "@babel/helpers": "https://ga.jspm.io/npm:@babel/helpers@7.22.5/lib/index.js",
          "@babel/highlight": "https://ga.jspm.io/npm:@babel/highlight@7.22.5/lib/index.js",
          "@babel/parser": "https://ga.jspm.io/npm:@babel/parser@7.22.5/lib/index.js",
          "@babel/plugin-syntax-import-assertions": "https://ga.jspm.io/npm:@babel/plugin-syntax-import-assertions@7.22.5/lib/index.js",
          "@babel/plugin-syntax-jsx": "https://ga.jspm.io/npm:@babel/plugin-syntax-jsx@7.22.5/lib/index.js",
          "@babel/plugin-syntax-typescript": "https://ga.jspm.io/npm:@babel/plugin-syntax-typescript@7.22.5/lib/index.js",
          "@babel/plugin-transform-modules-commonjs": "https://ga.jspm.io/npm:@babel/plugin-transform-modules-commonjs@7.22.5/lib/index.js",
          "@babel/plugin-transform-typescript": "https://ga.jspm.io/npm:@babel/plugin-transform-typescript@7.22.5/lib/index.js",
          "@babel/preset-typescript": "https://ga.jspm.io/npm:@babel/preset-typescript@7.22.5/lib/index.js",
          "@babel/template": "https://ga.jspm.io/npm:@babel/template@7.22.5/lib/index.js",
          "@babel/traverse": "https://ga.jspm.io/npm:@babel/traverse@7.22.5/lib/index.js",
          "@babel/types": "https://ga.jspm.io/npm:@babel/types@7.22.5/lib/index.js",
          "@codemirror/autocomplete": "https://ga.jspm.io/npm:@codemirror/autocomplete@6.8.1/dist/index.js",
          "@codemirror/commands": "https://ga.jspm.io/npm:@codemirror/commands@6.2.4/dist/index.js",
          "@codemirror/language": "https://ga.jspm.io/npm:@codemirror/language@6.8.0/dist/index.js",
          "@codemirror/lint": "https://ga.jspm.io/npm:@codemirror/lint@6.3.0/dist/index.js",
          "@codemirror/search": "https://ga.jspm.io/npm:@codemirror/search@6.5.0/dist/index.js",
          "@codemirror/state": "https://ga.jspm.io/npm:@codemirror/state@6.2.1/dist/index.js",
          "@codemirror/view": "https://ga.jspm.io/npm:@codemirror/view@6.14.0/dist/index.js",
          "@jridgewell/gen-mapping": "https://ga.jspm.io/npm:@jridgewell/gen-mapping@0.3.3/dist/gen-mapping.umd.js",
          "@jridgewell/resolve-uri": "https://ga.jspm.io/npm:@jridgewell/resolve-uri@3.1.0/dist/resolve-uri.umd.js",
          "@jridgewell/set-array": "https://ga.jspm.io/npm:@jridgewell/set-array@1.1.2/dist/set-array.umd.js",
          "@jridgewell/sourcemap-codec": "https://ga.jspm.io/npm:@jridgewell/sourcemap-codec@1.4.15/dist/sourcemap-codec.umd.js",
          "@jridgewell/trace-mapping": "https://ga.jspm.io/npm:@jridgewell/trace-mapping@0.3.18/dist/trace-mapping.umd.js",
          "@lezer/common": "https://ga.jspm.io/npm:@lezer/common@1.0.3/dist/index.js",
          "@lezer/highlight": "https://ga.jspm.io/npm:@lezer/highlight@1.1.6/dist/index.js",
          "ansi-styles": "https://ga.jspm.io/npm:ansi-styles@3.2.1/index.js",
          "assert": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/assert.js",
          "browserslist": "https://ga.jspm.io/npm:browserslist@4.21.9/index.js",
          "buffer": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/buffer.js",
          "caniuse-lite/dist/unpacker/agents": "https://ga.jspm.io/npm:caniuse-lite@1.0.30001510/dist/unpacker/agents.js",
          "cbor-x": "https://ga.jspm.io/npm:cbor-x@1.5.3/index.js",
          "chalk": "https://ga.jspm.io/npm:chalk@2.4.2/index.js",
          "color-convert": "https://ga.jspm.io/npm:color-convert@1.9.3/index.js",
          "color-name": "https://ga.jspm.io/npm:color-name@1.1.3/index.js",
          "convert-source-map": "https://ga.jspm.io/npm:convert-source-map@1.9.0/index.js",
          "crelt": "https://ga.jspm.io/npm:crelt@1.0.6/index.js",
          "crypto": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/crypto.js",
          "debug": "https://ga.jspm.io/npm:debug@4.3.4/src/browser.js",
          "electron-to-chromium/versions": "https://ga.jspm.io/npm:electron-to-chromium@1.4.442/versions.js",
          "es-module-lexer/js": "https://ga.jspm.io/npm:es-module-lexer@1.2.1/dist/lexer.asm.js",
          "escape-string-regexp": "https://ga.jspm.io/npm:escape-string-regexp@1.0.5/index.js",
          "eventemitter3": "https://ga.jspm.io/npm:eventemitter3@4.0.7/index.js",
          "fs": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/fs.js",
          "gensync": "https://ga.jspm.io/npm:gensync@1.0.0-beta.2/index.js",
          "globals": "https://ga.jspm.io/npm:globals@11.12.0/index.js",
          "js-tokens": "https://ga.jspm.io/npm:js-tokens@4.0.0/index.js",
          "jsesc": "https://ga.jspm.io/npm:jsesc@2.5.2/jsesc.js",
          "localforage": "https://ga.jspm.io/npm:localforage@1.10.0/dist/localforage.js",
          "lru-cache": "https://ga.jspm.io/npm:lru-cache@5.1.1/index.js",
          "ms": "https://ga.jspm.io/npm:ms@2.1.2/index.js",
          "node-releases/data/processed/envs.json": "https://ga.jspm.io/npm:node-releases@2.0.12/data/processed/envs.json.js",
          "node-releases/data/release-schedule/release-schedule.json": "https://ga.jspm.io/npm:node-releases@2.0.12/data/release-schedule/release-schedule.json.js",
          "path": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/path.js",
          "process": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/process.js",
          "semver": "https://ga.jspm.io/npm:semver@6.3.0/semver.js",
          "style-mod": "https://ga.jspm.io/npm:style-mod@4.0.3/src/style-mod.js",
          "supports-color": "https://ga.jspm.io/npm:supports-color@5.5.0/browser.js",
          "sver": "https://ga.jspm.io/npm:sver@1.8.4/sver.js",
          "sver/convert-range.js": "https://ga.jspm.io/npm:sver@1.8.4/convert-range.js",
          "to-fast-properties": "https://ga.jspm.io/npm:to-fast-properties@2.0.0/index.js",
          "url": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/url.js",
          "uuid": "https://ga.jspm.io/npm:uuid@8.3.2/dist/esm-browser/index.js",
          "w3c-keyname": "https://ga.jspm.io/npm:w3c-keyname@2.2.8/index.js",
          "xstate": "https://ga.jspm.io/npm:xstate@4.38.0/es/index.js",
          "xstate/lib/waitFor.js": "https://ga.jspm.io/npm:xstate@4.38.0/lib/dev.waitFor.js",
          "yallist": "https://ga.jspm.io/npm:yallist@3.1.1/yallist.js"
        },
        "https://ga.jspm.io/npm:@automerge/automerge@2.1.0-alpha.8/": {
          "uuid": "https://ga.jspm.io/npm:uuid@9.0.0/dist/esm-browser/index.js"
        },
        "https://ga.jspm.io/npm:@jridgewell/trace-mapping@0.3.18/": {
          "@jridgewell/sourcemap-codec": "https://ga.jspm.io/npm:@jridgewell/sourcemap-codec@1.4.14/dist/sourcemap-codec.umd.js"
        }
      }
    }
  </script>
  <script>
    window.esmsInitOptions = {
      shimMode: true,
      mapOverrides: true,
      polyfillEnable: ["css-modules", "json-modules"],
    }
    window.process = { env: {}, versions: {} }
  </script>
  <script type="module">
    import { Generator } from "@jspm/generator"
    import { ImportMap } from "@jspm/import-map"

    import { Repo } from "@automerge/automerge-repo"
    import { LocalForageStorageAdapter } from "@automerge/automerge-repo-storage-localforage"

    const repo = new Repo({
      storage: new LocalForageStorageAdapter(),
    })
    console.log("repo loaded", repo)

    /*

    // Total pseudocode here...

    const getDocFromUrl = () => {
      const url = new URL(window.location.href)
      const docId = url.searchParams.get("doc")
      if (docId) {
        return repo.find(docId)
      } else {
        const doc = repo.create()
        url.searchParams.set("doc", doc.docId)
        window.history.replaceState({}, "", url.toString())
        return doc
      }
    }

    const doc = getDocFromUrl()
    */

    const generator = new Generator({ importMap: importShim.importMap })

    await generator.install("codemirror")

    const importMap = generator.getMap()
    console.log("new map", importMap)
    console.log("old map", importShim.getImportMap())

    importShim.addImportMap(importMap)

    /* const { bootstrap } = import(doc.bootstrapDoc)
    bootstrap(repo)
    // and we're self-hosted from here on out
    */

    console.log("merged map", importShim.getImportMap())

    const CodeMirror = await import("codemirror")
    console.log(CodeMirror)
  </script>
  <div>Hello</div>
</html>
